# Claude Code Context for cal-date-widget

## Recent Changes (2025-12-04 - Session 2)

### Start Time Display Logic with Accurate Clipping Detection

**Problem:**
1. Start times were not displayed on days with plenty of space (Sat/Sun with sparse events)
2. Clipping detection was inaccurate - showing start times even when events were being clipped
3. Past events on current day were not limited to 1 line when clipping occurred

**Solution:** Implemented smart start time display logic with accurate clipping detection

**Key Changes:**

1. **WeeklyDisplayLogic.kt - shouldShowStartTimes() (lines 81-93)**
   - Determines if start times should be shown based on available space
   - Uses conservative estimate: 4 lines per event (accounts for start time text + wrapping)
   - Formula: `(eventCount * lineHeight * 4.0f) <= availableHeight`
   - Returns true only when ALL events will fit WITH start times

2. **WeeklyDisplayLogic.kt - getMaxLinesForCurrentDayEvent() (lines 107-130)**
   - Extracted testable function for max lines calculation on current day
   - When NO clipping: Returns 10 (generous lines for all events)
   - When clipping + past event: Returns 1 (minimize past events)
   - When clipping + future event: Equitable distribution of remaining space
   - Formula for future: `(availableHeight - pastEventsHeight) / (futureCount * lineHeight)`

3. **WeeklyWidgetProvider.kt - Updated to use new functions (lines 210-214)**
   - Calls `WeeklyDisplayLogic.shouldShowStartTimes()` for each day
   - Uses result to show/hide start times in event text
   - `isClipping = !showStartTimes` for consistent behavior

**Test Coverage (WeeklyDisplayLogicTest.kt):**
- 11 tests for shouldShowStartTimes() covering various scenarios
- 5 tests for getMaxLinesForCurrentDayEvent() including realistic device scenarios
- Tests verify: clipping detection, boundary conditions, current day behavior
- Realistic test uses actual device metrics (761px height, 86.4px line height, 4 events)

**Behavior:**
- **Days with sparse events (Sat/Sun):** Start times shown, events have room to breathe
- **Days with many events:** Start times hidden, past events limited to 1 line
- **Estimate accuracy:** 4 lines per event provides reliable clipping detection
- **From logs:** 4 events with estimate=1382.4px > available=761px → correctly detects clipping

**Results:**
- Start times now display on Sat/Sun when there's space ✓
- Clipping accurately detected (showStartTimes: false when isClipping: true) ✓
- Past events limited to 1 line when clipping (MaxLines: 1) ✓
- Future events get equitable space distribution (MaxLines: 3) ✓

## Recent Changes (2025-12-04 - Session 1)

### Week Widget - Equitable Event Clipping Distribution
**Problem:** Events were clipped inequitably - one event taking 4 rows, last event only 1.75 rows
**Solution:** Implemented intelligent line distribution in `WeeklyWidgetProvider.kt` (lines 216-270)

**Clipping Logic:**
- **Current day with clipping:**
  - Past events (already ended): Limited to 1 row max
  - Current/future events: Equitable distribution of remaining space
- **Past/future days with clipping:** All events share space equitably
- **No clipping:** All events can use up to 10 rows

**Critical Bug Fix (line 327):**
- `StaticLayout.setMaxLines()` doesn't enforce limits without ellipsize
- Added `.setEllipsize(TextUtils.TruncateAt.END)` to make maxLines work
- Before fix: maxLines=1 but actualLines=2 (ignored)
- After fix: maxLines=1 and actualLines=1 (respected)

**Debug Logging Added (lines 229-267, 332-334):**
- Tracks clipping detection, event counts, max lines per event
- Logs actual vs requested line counts for verification
- Use: `adb logcat -s WeeklyWidget:D`

**Result:** More equitable space distribution, past events minimized on current day

## Architecture Notes

### Week Widget Rendering (WeeklyWidgetProvider.kt)
- Widget renders entire calendar as bitmap on Canvas
- Each day is a column with dynamic width based on past/today/future
- **Today's column:** Gets 2.0x width weight and larger text (textSizeScale, default 1.5)
- **Past days:** 0.6x width, 1.0x text scale, dimmed if event ended
- **Future days:** 1.5-0.7x width (declining), 1.10x text scale
- **Event rendering:** Uses StaticLayout with dynamic maxLines based on clipping
  - Clipping detected when: `(dayEvents.size * estimatedHeightPerEvent) > availableHeight`
  - Current day past events: 1 line max when clipping
  - Current day future events: Equitable distribution when clipping
  - Other days: Equitable distribution across all events when clipping
  - No clipping: Up to 10 lines per event
- **Ellipsize:** TruncateAt.END (required for maxLines to work correctly)
- **Canvas clipping:** Hard clips at widget boundaries for final overflow

### Start Time Display Logic
- Start times are shown/hidden adaptively based on available space
- Calculation: `(dayEvents.size * estimatedHeightPerEvent) <= availableHeight`
- When hidden, saves space to fit more events
- Start times have custom color (settings.startTimeColor) and shadow

### Event Deduplication
- Events with identical title, start time, end time, and all-day status are deduplicated
- See `CalendarRepository.kt` lines 94-96

## Build & Test
- Device: SM-F936U1 (Samsung Galaxy Z Fold4)
- ADB path: `~/Library/Android/sdk/platform-tools/adb`
- Build: `./gradlew assembleDebug`
- Install: `./gradlew installDebug`
- Screenshot: `adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png /tmp/widget_screenshot.png`

## Known Patterns
- Settings managed via `PrefsManager`
- Widget updates via `AppWidgetManager.updateAppWidget()`
- Calendar data fetched via `CalendarRepository`

## Pending/Future Considerations
- Consider removing debug logging in production/release builds for performance
- Could make "1 row for past events" threshold configurable in settings
- Consider making max lines (currently up to 10) configurable via settings
- Monitor if ellipsize truncation UX is preferred vs ungraceful clipping
- Consider making the 4-line estimate per event configurable if different text sizes need different estimates
